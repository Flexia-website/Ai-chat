<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Clinton Tech AI · golden touch</title>
  <!-- Font Awesome 6 (free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(circle at 10% 30%, #f9eac3, #fcf5e6);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 12px;
      height: 100vh;
      overflow: hidden;
    }

    .chat-container {
      width: 100%;
      max-width: 1100px;
      height: 95vh;
      max-height: 900px;
      background: rgba(255, 250, 240, 0.75);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-radius: 42px;
      box-shadow: 0 30px 60px -20px rgba(120, 70, 0, 0.3), inset 0 1px 2px rgba(255, 245, 200, 0.7);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(255, 215, 0, 0.25);
    }

    .chat-header {
      background: rgba(70, 50, 20, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #fff9e6;
      padding: 18px 26px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 215, 0, 0.4);
      flex-shrink: 0;
    }

    .bot-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .bot-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(145deg, #f5c542, #b8860b);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      color: #2a1f0c;
      box-shadow: 0 10px 20px -6px rgba(212, 175, 55, 0.5);
    }

    .bot-name {
      font-weight: 650;
      font-size: 1.4rem;
      letter-spacing: -0.4px;
      color: #fff2c0;
    }

    .bot-status {
      font-size: 0.75rem;
      background: #d4a017;
      padding: 5px 12px;
      border-radius: 40px;
      color: #1f1407;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
      backdrop-filter: blur(4px);
      border: 0.5px solid rgba(255, 230, 130, 0.6);
    }

    .chat-messages {
      flex: 1 1 auto;
      padding: 26px 28px;
      overflow-y: auto;
      background: rgba(250, 240, 220, 0.3);
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 0;
    }

    .message {
      max-width: 85%;
      padding: 16px 22px;
      border-radius: 28px;
      line-height: 1.55;
      word-wrap: break-word;
      animation: appear 0.3s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,0.02);
      font-size: 0.98rem;
    }

    @keyframes appear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      align-self: flex-end;
      background: #4a3720;
      color: #fff2d7;
      border-bottom-right-radius: 8px;
      box-shadow: 0 12px 22px -10px #4a3720cc;
    }

    .bot-message {
      align-self: flex-start;
      background: #fffefae0;
      backdrop-filter: blur(4px);
      color: #2f2a1f;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-bottom-left-radius: 8px;
      box-shadow: 0 12px 22px -10px rgba(150, 100, 0, 0.2);
    }

    .bot-message strong, .user-message strong {
      font-weight: 700;
    }
    .user-message strong {
      color: #ffdb7c;
    }

    .code-block-wrapper {
      margin: 16px 0 10px;
      border-radius: 20px;
      background: #2f2a1f;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(0,0,0,0.3);
      border: 1px solid #a67c1e;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 18px;
      background: #594e2c;
      color: #f7eac6;
      font-size: 0.85rem;
      border-bottom: 1px solid #a67c1e;
    }

    .code-actions {
      display: flex;
      gap: 12px;
    }

    .code-actions button {
      background: none;
      border: none;
      color: #f7eac6;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 5px 8px;
      border-radius: 8px;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .code-actions button:hover {
      background: #7e6a35;
      color: white;
    }

    .code-block {
      padding: 18px;
      overflow-x: auto;
      background: #2f2a1f;
      color: #f7f0d9;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 16px 22px;
      background: #fffef2;
      border-radius: 36px;
      border-bottom-left-radius: 8px;
      width: fit-content;
      border: 1px solid rgba(212, 175, 55, 0.2);
      box-shadow: 0 8px 16px -12px #3a2e1a;
    }
    .typing-indicator span {
      width: 9px;
      height: 9px;
      background: #c9a03d;
      border-radius: 50%;
      display: inline-block;
      opacity: 0.6;
      animation: bounce 1.3s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
      30% { transform: translateY(-12px); opacity: 1; }
    }

    .chat-input-area {
      display: flex;
      padding: 18px 26px;
      background: rgba(255, 245, 220, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(212, 175, 55, 0.2);
      gap: 14px;
      flex-shrink: 0;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      background: white;
      border-radius: 60px;
      padding: 5px 5px 5px 22px;
      border: 1px solid rgba(180, 130, 30, 0.15);
      box-shadow: 0 10px 20px -12px #7e5f2a;
      transition: all 0.2s;
    }
    .input-wrapper:focus-within {
      border-color: #b8860b;
      box-shadow: 0 10px 24px -10px #b8860b;
    }
    #userInput {
      flex: 1;
      border: none;
      padding: 14px 0;
      font-size: 1rem;
      background: transparent;
      outline: none;
      font-family: inherit;
    }

    #sendBtn {
      background: #b8860b;
      color: #1f1407;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.4rem;
      box-shadow: 0 12px 22px -10px #b37b2e;
      padding: 0;
    }
    #sendBtn:hover {
      background: #dba432;
      transform: scale(1.05);
      color: #2a1f0c;
    }
    #sendBtn i {
      line-height: 1;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #fffbf0;
      width: 90%;
      max-width: 1000px;
      height: 80%;
      border-radius: 28px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 40px 70px -20px #3a2e1a;
      border: 1px solid #e0b354;
    }
    .modal-header {
      padding: 18px 24px;
      background: #7e632a;
      color: #fff2c0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .close-modal {
      background: none;
      border: none;
      color: #fff2c0;
      font-size: 2rem;
      cursor: pointer;
      line-height: 1;
    }
    .modal-body {
      flex: 1;
      background: #fcf2de;
    }
    #previewFrame {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    @media (max-width: 768px) {
      .chat-header {
        padding: 14px 20px;
      }
      .bot-avatar {
        width: 42px;
        height: 42px;
        font-size: 22px;
      }
      .bot-name {
        font-size: 1.2rem;
      }
      .chat-messages {
        padding: 20px 22px;
      }
      .message {
        max-width: 90%;
        padding: 14px 18px;
        font-size: 0.95rem;
      }
      .chat-input-area {
        padding: 14px 20px;
      }
      #userInput {
        padding: 12px 0;
      }
      #sendBtn {
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      .chat-container {
        border-radius: 30px;
      }
      .chat-messages {
        padding: 16px;
      }
      .message {
        max-width: 98%;
        font-size: 0.9rem;
        padding: 12px 16px;
      }
      .input-wrapper {
        padding-left: 16px;
      }
      #userInput {
        padding: 10px 0;
        font-size: 0.95rem;
      }
      #sendBtn {
        width: 44px;
        height: 44px;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="bot-info">
        <div class="bot-avatar">
          <i class="fas fa-crown"></i>
        </div>
        <div>
          <div class="bot-name">Clinton Tech AI</div>
          <div class="bot-status">
            <i class="fas fa-circle"></i> personal
          </div>
        </div>
      </div>
      <div style="color: rgba(255, 235, 150, 0.8); font-size: 1.3rem;">
        <i class="fas fa-sliders-h"></i>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-area">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="Ask me anything..." autocomplete="off">
      </div>
      <button id="sendBtn" aria-label="Send message">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <div class="modal" id="previewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-eye"></i> HTML Preview</h3>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // ==================== MULTI-API KEY CONFIGURATION ====================
      // Define your API configurations with multiple keys per provider
      // These will read from environment variables set in Render
      
      const API_CONFIGS = [
        { 
          name: 'Gemini',
          type: 'gemini',
          // Split comma-separated string into array of keys
          // Format in Render: GEMINI_API_KEYS=key1,key2,key3,key4,key5
          keys: (typeof process !== 'undefined' && process.env && process.env.GEMINI_API_KEYS) 
            ? process.env.GEMINI_API_KEYS.split(',') 
            : ['AIzaSyD1PS21YAO4l_UIMRVQDE8-A44siMuMfjM'], // Fallback default key
          model: 'gemini-2.5-flash',
          url: (model) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=`,
          currentKeyIndex: 0,
          failedKeys: []
        },
        { 
          name: 'OpenAI',
          type: 'openai',
          // Format in Render: OPENAI_API_KEYS=sk-key1,sk-key2,sk-key3
          keys: (typeof process !== 'undefined' && process.env && process.env.OPENAI_API_KEYS) 
            ? process.env.OPENAI_API_KEYS.split(',') 
            : [],
          model: 'gpt-3.5-turbo',
          url: 'https://api.openai.com/v1/chat/completions',
          currentKeyIndex: 0,
          failedKeys: []
        },
        { 
          name: 'DeepSeek',
          type: 'deepseek',
          // Format in Render: DEEPSEEK_API_KEYS=deepsek-key1,deepsek-key2
          keys: (typeof process !== 'undefined' && process.env && process.env.DEEPSEEK_API_KEYS) 
            ? process.env.DEEPSEEK_API_KEYS.split(',') 
            : [],
          model: 'deepseek-chat',
          url: 'https://api.deepseek.com/v1/chat/completions',
          currentKeyIndex: 0,
          failedKeys: []
        },
        { 
          name: 'Anthropic',
          type: 'anthropic',
          // Format in Render: ANTHROPIC_API_KEYS=sk-ant-key1,sk-ant-key2
          keys: (typeof process !== 'undefined' && process.env && process.env.ANTHROPIC_API_KEYS) 
            ? process.env.ANTHROPIC_API_KEYS.split(',') 
            : [],
          model: 'claude-3-sonnet-20240229',
          url: 'https://api.anthropic.com/v1/messages',
          currentKeyIndex: 0,
          failedKeys: []
        }
      ];

      // Filter out providers with no keys
      const activeAPIs = API_CONFIGS.filter(api => api.keys && api.keys.length > 0);
      
      if (activeAPIs.length === 0) {
        // Fallback to ensure at least Gemini works with default key
        activeAPIs.push({
          name: 'Gemini',
          type: 'gemini',
          keys: ['AIzaSyD1PS21YAO4l_UIMRVQDE8-A44siMuMfjM'],
          model: 'gemini-2.5-flash',
          url: (model) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=`,
          currentKeyIndex: 0,
          failedKeys: []
        });
      }

      // Track which provider we're currently using
      let currentProviderIndex = 0;

      // Key rotation and failover functions
      function getNextKey(provider) {
        if (!provider.keys || provider.keys.length === 0) {
          return null;
        }
        
        // Try to find a working key (skip recently failed ones)
        let attempts = 0;
        const maxAttempts = provider.keys.length;
        
        while (attempts < maxAttempts) {
          const key = provider.keys[provider.currentKeyIndex];
          
          // Move to next key for next time (round-robin)
          provider.currentKeyIndex = (provider.currentKeyIndex + 1) % provider.keys.length;
          
          // Check if this key is in failed list (and maybe retry after cooldown)
          const failedEntry = provider.failedKeys.find(f => f.key === key);
          if (!failedEntry || Date.now() > failedEntry.retryAfter) {
            // Remove from failed list if cooldown expired
            if (failedEntry) {
              provider.failedKeys = provider.failedKeys.filter(f => f.key !== key);
            }
            return key;
          }
          
          attempts++;
        }
        
        // All keys are in cooldown - use the first one anyway as last resort
        return provider.keys[0];
      }

      function markKeyFailed(provider, key, cooldownMs = 60000) {
        console.log(`Key failed for ${provider.name}, cooling down for ${cooldownMs}ms`);
        provider.failedKeys.push({
          key: key,
          retryAfter: Date.now() + cooldownMs
        });
        
        // Keep failed list manageable
        if (provider.failedKeys.length > 10) {
          provider.failedKeys = provider.failedKeys.slice(-10);
        }
      }

      // Main API call with multi-key rotation and cross-provider failover
      async function getBotResponse(userMessage) {
        const startProviderIndex = currentProviderIndex;
        let attempts = 0;
        const maxAttempts = activeAPIs.length * 3; // Try each provider up to 3 times with different keys
        
        while (attempts < maxAttempts) {
          const provider = activeAPIs[currentProviderIndex];
          const key = getNextKey(provider);
          
          if (!key) {
            // No keys available for this provider, move to next
            currentProviderIndex = (currentProviderIndex + 1) % activeAPIs.length;
            attempts++;
            continue;
          }
          
          try {
            console.log(`Attempting with ${provider.name} using key index ${provider.currentKeyIndex}`);
            
            let reply;
            if (provider.type === 'gemini') {
              reply = await callGemini(provider, key, userMessage);
            } else if (provider.type === 'openai') {
              reply = await callOpenAI(provider, key, userMessage);
            } else if (provider.type === 'deepseek') {
              reply = await callDeepSeek(provider, key, userMessage);
            } else if (provider.type === 'anthropic') {
              reply = await callAnthropic(provider, key, userMessage);
            } else {
              throw new Error(`Unknown provider type: ${provider.type}`);
            }
            
            // Success! Stay on this provider for next request
            return reply;
            
          } catch (error) {
            console.error(`${provider.name} failed:`, error.message);
            
            // Mark key as failed based on error type
            if (error.status === 429) {
              markKeyFailed(provider, key, 60000); // Rate limit - 1 min cooldown
            } else if (error.status === 401 || error.status === 403) {
              markKeyFailed(provider, key, 300000); // Auth error - 5 min cooldown
            } else if (error.status >= 500) {
              markKeyFailed(provider, key, 30000); // Server error - 30 sec cooldown
            } else {
              markKeyFailed(provider, key, 10000); // Other errors - 10 sec cooldown
            }
            
            // Move to next provider
            currentProviderIndex = (currentProviderIndex + 1) % activeAPIs.length;
            attempts++;
          }
        }
        
        // If we exhausted all attempts
        return "I'm having trouble connecting right now. Please try again later.";
      }

      // Provider-specific API calls
      async function callGemini(provider, key, userMessage) {
        const requestBody = {
          contents: [{ 
            role: "user", 
            parts: [{ text: userMessage }] 
          }],
          systemInstruction: { 
            parts: [{ 
              text: "You are Clinton Tech AI, a warm and helpful technical assistant. When showing code, use triple backticks with the language (e.g., ```html ... ```). You can use **bold** for emphasis. Keep responses clear and friendly." 
            }] 
          }
        };
        
        const fullUrl = provider.url(provider.model) + key;
        const response = await fetch(fullUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const error = new Error(`HTTP ${response.status}`);
          error.status = response.status;
          throw error;
        }
        
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "No reply from Gemini.";
      }

      async function callOpenAI(provider, key, userMessage) {
        const requestBody = {
          model: provider.model,
          messages: [
            { role: "system", content: "You are Clinton Tech AI, a warm and helpful technical assistant. Use **bold** and code blocks with language labels." },
            { role: "user", content: userMessage }
          ]
        };
        
        const response = await fetch(provider.url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const error = new Error(`HTTP ${response.status}`);
          error.status = response.status;
          throw error;
        }
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || "No reply from OpenAI.";
      }

      async function callDeepSeek(provider, key, userMessage) {
        const requestBody = {
          model: provider.model,
          messages: [
            { role: "system", content: "You are Clinton Tech AI, a warm and helpful technical assistant. Use **bold** and code blocks." },
            { role: "user", content: userMessage }
          ]
        };
        
        const response = await fetch(provider.url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const error = new Error(`HTTP ${response.status}`);
          error.status = response.status;
          throw error;
        }
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || "No reply from DeepSeek.";
      }

      async function callAnthropic(provider, key, userMessage) {
        const requestBody = {
          model: provider.model,
          max_tokens: 1024,
          messages: [
            { role: "user", content: userMessage }
          ],
          system: "You are Clinton Tech AI, a warm and helpful technical assistant. Use **bold** and code blocks with language labels."
        };
        
        const response = await fetch(provider.url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': key,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const error = new Error(`HTTP ${response.status}`);
          error.status = response.status;
          throw error;
        }
        
        const data = await response.json();
        return data.content?.[0]?.text || "No reply from Anthropic.";
      }

      // ========== UI CODE (unchanged) ==========
      const chatMessages = document.getElementById('chatMessages');
      const userInput = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const previewModal = document.getElementById('previewModal');
      const previewFrame = document.getElementById('previewFrame');
      const closeModalBtn = document.getElementById('closeModalBtn');

      closeModalBtn.addEventListener('click', () => {
        previewModal.classList.remove('active');
        previewFrame.srcdoc = '';
      });
      
      window.addEventListener('click', (e) => {
        if (e.target === previewModal) {
          previewModal.classList.remove('active');
          previewFrame.srcdoc = '';
        }
      });

      function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, (m) => {
          if (m === '&') return '&amp;';
          if (m === '<') return '&lt;';
          if (m === '>') return '&gt;';
          if (m === '"') return '&quot;';
          return m;
        });
      }

      function parseMessage(text) {
        const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
        const blocks = [];
        let match;
        let lastIndex = 0;
        let parts = [];

        while ((match = codeBlockRegex.exec(text)) !== null) {
          const before = text.slice(lastIndex, match.index);
          if (before) parts.push({ type: 'text', content: before });
          const lang = match[1] || 'plaintext';
          const code = match[2];
          blocks.push({ lang, code });
          parts.push({ type: 'code', index: blocks.length - 1 });
          lastIndex = match.index + match[0].length;
        }
        if (lastIndex < text.length) {
          parts.push({ type: 'text', content: text.slice(lastIndex) });
        }

        let html = '';
        for (let part of parts) {
          if (part.type === 'text') {
            let escaped = escapeHtml(part.content);
            escaped = escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html += escaped;
          } else {
            const block = blocks[part.index];
            const lang = block.lang;
            const code = block.code;
            const codeForDisplay = escapeHtml(code);

            html += `
              <div class="code-block-wrapper" data-code="${encodeURIComponent(code)}">
                <div class="code-header">
                  <span><i class="fas fa-code"></i> ${lang}</span>
                  <div class="code-actions">
                    ${lang.toLowerCase() === 'html' ? `<button class="preview-btn" title="Preview HTML"><i class="fas fa-eye"></i><span> Preview</span></button>` : ''}
                    <button class="copy-btn" title="Copy to clipboard"><i class="fas fa-copy"></i><span> Copy</span></button>
                  </div>
                </div>
                <div class="code-block">
                  <code>${codeForDisplay}</code>
                </div>
              </div>
            `;
          }
        }
        return html;
      }

      function addMessage(text, sender) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');

        if (sender === 'user') {
          msgDiv.innerHTML = escapeHtml(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        } else {
          msgDiv.innerHTML = parseMessage(text);
        }

        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (sender === 'bot') {
          msgDiv.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const wrapper = btn.closest('.code-block-wrapper');
              const code = decodeURIComponent(wrapper.dataset.code);
              navigator.clipboard.writeText(code).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i><span> Copied!</span>';
                setTimeout(() => { btn.innerHTML = original; }, 2000);
              }).catch(() => alert('Failed to copy.'));
            });
          });

          msgDiv.querySelectorAll('.preview-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const wrapper = btn.closest('.code-block-wrapper');
              const code = decodeURIComponent(wrapper.dataset.code);
              previewFrame.srcdoc = code;
              previewModal.classList.add('active');
            });
          });
        }
      }

      function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.classList.add('typing-indicator');
        indicator.id = 'typingIndicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
      }

      async function handleSend() {
        const message = userInput.value.trim();
        if (!message) return;

        userInput.disabled = true;
        sendBtn.disabled = true;

        addMessage(message, 'user');
        userInput.value = '';

        showTypingIndicator();

        const reply = await getBotResponse(message);

        removeTypingIndicator();
        addMessage(reply, 'bot');

        userInput.disabled = false;
        sendBtn.disabled = false;
        userInput.focus();
      }

      sendBtn.addEventListener('click', handleSend);
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSend();
      });

      // Simple welcome message without API count
      addMessage("Hello! I'm **Clinton Tech AI**, your personal coding companion with a golden heart. ✨ I can help you write, explain, and preview code. Try me — paste any code or ask a question!", 'bot');

    })();
  </script>
</body>
</html>
